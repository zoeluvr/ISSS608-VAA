---
title: "Take-home_Ex04_draft"
---

```{r}
pacman::p_load(scales, viridis, lubridate, ggthemes, gridExtra, readxl, knitr, data.table, CGPfunctions, ggHoriPlot, ggrepel, ggiraph, plotly, ggh4x, patchwork, gganimate, tidyverse)
```

```{r}
impodata <- read_xlsx("data/merc.xlsx",
                       sheet = "T1",
                       range = cell_rows(10:128)) %>%
  select(`Data Series`, contains(c("2020", "2021", "2022"))) 

expodata <- read_xlsx("data/merc.xlsx",
                       sheet = "T2",
                       range = cell_rows(10:100)) %>%
  select(`Data Series`, contains(c("2020", "2021", "2022"))) 
```

```{r}
impodata_pivot <- impodata %>% 
  pivot_longer( 
     cols = `2020 Dec`:`2022 Jan`, 
     names_to = "Import_Date",
     values_transform = as.numeric,
     values_to = "Import_Value") %>% 
  pivot_wider(        
    names_from = `Data Series`,
    values_from = Import_Value
  ) 

expodata_pivot <- expodata %>% 
  pivot_longer( 
     cols = `2020 Dec`:`2022 Jan`, 
     names_to = "Export_Date",
     values_transform = as.numeric,
     values_to = "Export_Value") %>% 
  pivot_wider(        
    names_from = `Data Series`,
    values_from = Export_Value
  ) 
```

```{r}
impodata_pivot$`Import_Date` <- ym(impodata_pivot$`Import_Date`)
expodata_pivot$`Export_Date` <- ym(expodata_pivot$`Export_Date`)
```

```{r}
imp <- impodata_pivot %>% 
  mutate_at(vars(contains('Million Dollars')), ~ (. *1000)) 
exp <- expodata_pivot %>% 
  mutate_at(vars(contains('Million Dollars')), ~ (. *1000)) 
```

```{r}
colnames(imp) <- gsub(" (Million Dollars)", "", colnames(imp), fixed = TRUE)
colnames(imp) <- gsub(" (Thousand Dollars)", "", colnames(imp), fixed = TRUE)
colnames(exp) <- gsub(" (Million Dollars)", "", colnames(exp), fixed = TRUE)
colnames(exp) <- gsub(" (Thousand Dollars)", "", colnames(exp), fixed = TRUE)
```

```{r}
imp_con <- imp %>% 
  pivot_longer(-Import_Date, 
               names_to = "Region",
               values_to = "Import_Value(KUSD)") 
```

```{r}
imp_con$Import_Month <- factor(month(imp_con$Import_Date), 
                    levels=1:12, 
                    labels=month.abb, 
                    ordered=TRUE) 
imp_con$Import_Year <- year(ymd(imp_con$Import_Date))
```

```{r}
exp_con <- exp %>% 
  pivot_longer(-Export_Date, 
               names_to = "Region",
               values_to = "Export_Value(KUSD)") 
```

```{r}
exp_con$Export_Month <- factor(month(exp_con$Export_Date), 
                    levels=1:12, 
                    labels=month.abb, 
                    ordered=TRUE) 
exp_con$Export_Year <- year(ymd(exp_con$Export_Date))
```

```{r}
balance_data <- imp_con %>% 
  inner_join(exp_con, by = c("Region" = "Region", "Import_Date" = "Export_Date", "Import_Month" = "Export_Month", "Import_Year" = "Export_Year"))
```

```{r}
  names(balance_data) <- c("Date", "Region", "Import_Value(KUSD)", "Month", "Year", "Export_Value(KUSD)")
```

```{r}
balance_data <- balance_data %>% 
  mutate(BOT = `Export_Value(KUSD)` - `Import_Value(KUSD)`)  %>% 
  mutate(Trade_Volume = `Export_Value(KUSD)` + `Import_Value(KUSD)`)
```

```{r}
#| fig-width: 12
#| fig-height: 12
balance_data %>% 
  group_by(Region) %>% 
  filter(Region !="Asia" & Region != "America" & Region != "Europe" & Region != "Africa" & Region != "Oceania" & Region != "European Union") %>% 
  ungroup() %>% 
  na.omit() %>% 
  ggplot() +
  geom_horizon(aes(x = Date, y=BOT), 
               origin = "midpoint", 
               horizonscale = 6)+
  facet_grid(`Region`~.) +
    theme_few() +
  scale_fill_hcl(palette = 'RdBu') +
  theme(panel.spacing.y=unit(0, "lines"), strip.text.y = element_text(
    size = 5, angle = 0, hjust = 0),
    legend.position = 'none',
    axis.text.y = element_blank(),
    axis.text.x = element_text(size=7),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.ticks.y = element_blank(),
    panel.border = element_blank()
    ) +
    scale_x_date(expand=c(0,0), date_breaks = "2 month", date_labels = "%b%y") +
  ggtitle("Singapore's Balance of Trade by Country (Jan 2020 to Dec 2022)")
```
```{r}
bubble_data <- balance_data %>% 
  group_by(Region) %>% 
  filter(Region !="Asia" & Region != "America" & Region != "Europe" & Region != "Africa" & Region != "Oceania" & Region != "European Union") %>% 
  ungroup() %>% 
  na.omit() %>% 
  select(Region, Year, `Import_Value(KUSD)`, `Export_Value(KUSD)`, Trade_Volume) %>% 
  mutate("Import_Value(MUSD)" = `Import_Value(KUSD)`/1000) %>% 
  mutate("Export_Value(MUSD)" = `Export_Value(KUSD)`/1000) %>% 
  mutate("Trade_Volume" = Trade_Volume/1000) %>% 
  mutate_each_(funs(factor(.)), "Region") %>% 
  mutate(Year = as.integer(Year))
```

```{r}
#| fig-width: 12
#| fig-height: 12
ggplot(bubble_data, aes(x = `Import_Value(MUSD)`, 
                        y = `Export_Value(MUSD)`,
                      size = Trade_Volume, 
                      colour = Region)) +
  geom_point(alpha = 0.7, 
             show.legend = FALSE) +
  scale_size(range = c(2, 12)) +
  labs(title = "Singapore's Merchandise Trade Performance with Trading Partners \n Year: {frame_time}") +
  transition_time(Year) +       
  ease_aes('linear')            
```

```{r}
top6_volume <- balance_data %>% 
  group_by(Region) %>% 
  filter(Region !="Asia" & Region != "America" & Region != "Europe" & Region != "Africa" & Region != "Oceania" & Region != "European Union") %>% 
  summarise("Total_Volume" = sum(`Trade_Volume`)) %>% 
  ungroup() %>% 
  arrange(desc(Total_Volume))
top6_volume <- top6_volume$Region[1:6]
```

```{r}
line_top6 <- balance_data %>% 
  group_by(Region) %>% 
  filter(Region %in% top6_volume) %>% 
  ungroup() %>% 
  mutate("Import_Value(MUSD)" = `Import_Value(KUSD)`/1000) %>% 
  mutate("Export_Value(MUSD)" = `Export_Value(KUSD)`/1000)
```

```{r}
line_top6p <-
  ggplot(line_top6, aes(x = Date)) +
  geom_line(aes(y = `Export_Value(MUSD)`, color = "Export")) +
  geom_line(aes(y = `Import_Value(MUSD)`, color = "Import")) +
  facet_wrap(~Region, ncol = 3) + 
  stat_difference(aes(ymin = `Import_Value(MUSD)`, ymax = `Export_Value(MUSD)`), alpha = 0.3) +
  labs(x = "Time", y = "Trade Value (MUSD)", 
     title = "Monthly Import and Export Value of Singapore's Top Trading Partners (2020-2022)") +
  theme(axis.ticks = element_blank(),
        axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_text(size = 8),
        legend.text = element_text(size = 6) )
```


```{r}
bar_top6 <- line_top6 %>% 
  select(Region, Year, `Export_Value(MUSD)`, `Import_Value(MUSD)`) %>% 
  pivot_longer(cols = `Export_Value(MUSD)`:`Import_Value(MUSD)`, names_to = "Category") %>% 
  group_by(Region, Year, Category) %>% 
  summarise("Value" = sum(`value`)) %>% 
  ungroup()
```

```{r}
bar_top6p <-
  ggplot(bar_top6, aes(fill=Category, y=Value, x=Year)) + 
    geom_bar(position="stack", stat="identity") +
  facet_wrap(~Region,ncol = 6) +
  labs( title = "Yearly Import and Export Value of Singapore's Top Trading Partners (2020-2022)") +
  theme(axis.text.x = element_text(size = 5),
        axis.text.y = element_text(size = 5))
```

```{r}
#| fig-width: 12
#| fig-height: 12
subplot(bar_top6p, line_top6p, nrows = 2)
```

```{r}
imp$month <- factor(month(imp$`Import_Date`), 
                    levels=1:12, 
                    labels=month.abb, 
                    ordered=TRUE) 
imp$year <- year(ymd(imp$`Import_Date`))
```

```{r}
ch_import <- imp %>% 
  ggplot() +
  geom_line(aes(x=year, 
                y=`Mainland China`, 
                group=month), 
            colour="black") +
  facet_grid(~month)
ch_import
```
